<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Concepts | DanielGao&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Hello World">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.84cbfe9a.js" as="script"><link rel="preload" href="/assets/js/2.97ad032c.js" as="script"><link rel="preload" href="/assets/js/10.6f6050b0.js" as="script"><link rel="prefetch" href="/assets/js/11.314a169a.js"><link rel="prefetch" href="/assets/js/12.44c5ee57.js"><link rel="prefetch" href="/assets/js/13.f2574ab5.js"><link rel="prefetch" href="/assets/js/14.9878853c.js"><link rel="prefetch" href="/assets/js/15.6fb7ebac.js"><link rel="prefetch" href="/assets/js/16.0ad1fc40.js"><link rel="prefetch" href="/assets/js/17.24a22417.js"><link rel="prefetch" href="/assets/js/18.f1919206.js"><link rel="prefetch" href="/assets/js/19.25662fd9.js"><link rel="prefetch" href="/assets/js/3.60832a0f.js"><link rel="prefetch" href="/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/assets/js/5.6eff8140.js"><link rel="prefetch" href="/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/assets/js/7.e59ee139.js"><link rel="prefetch" href="/assets/js/8.7162edc7.js"><link rel="prefetch" href="/assets/js/9.67af75ac.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DanielGao's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Back End
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back_end/docker_command.html" class="nav-link">
  Docker 命令
</a></li><li class="dropdown-subitem"><a href="/back_end/docker_jottings.html" class="nav-link">
  Docker 随笔
</a></li><li class="dropdown-subitem"><a href="/back_end/Kubernetes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  K8S
</a></li><li class="dropdown-subitem"><a href="/back_end/redis_start.html" class="nav-link">
  Redis Start
</a></li></ul></li><li class="dropdown-item"><h4>
          Algorithm notes
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/algorithm/basic_template.html" class="nav-link">
  常用算法模板
</a></li><li class="dropdown-subitem"><a href="/algorithm/PAT.html" class="nav-link">
  PAT tips
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便写写" class="dropdown-title"><span class="title">随便写写</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便写写" class="mobile-dropdown-title"><span class="title">随便写写</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jottings/introduction.html" class="nav-link">
  前言
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Gaoyan1999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Back End
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back_end/docker_command.html" class="nav-link">
  Docker 命令
</a></li><li class="dropdown-subitem"><a href="/back_end/docker_jottings.html" class="nav-link">
  Docker 随笔
</a></li><li class="dropdown-subitem"><a href="/back_end/Kubernetes.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  K8S
</a></li><li class="dropdown-subitem"><a href="/back_end/redis_start.html" class="nav-link">
  Redis Start
</a></li></ul></li><li class="dropdown-item"><h4>
          Algorithm notes
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/algorithm/basic_template.html" class="nav-link">
  常用算法模板
</a></li><li class="dropdown-subitem"><a href="/algorithm/PAT.html" class="nav-link">
  PAT tips
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便写写" class="dropdown-title"><span class="title">随便写写</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便写写" class="mobile-dropdown-title"><span class="title">随便写写</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jottings/introduction.html" class="nav-link">
  前言
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Gaoyan1999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Concepts</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back_end/Kubernetes.html#overview" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#why-you-need-kubernetes-and-what-it-can-do" class="sidebar-link">Why you need Kubernetes and what it can do</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#kubernetes-components" class="sidebar-link">Kubernetes Components</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#the-kubernetes-api" class="sidebar-link">The Kubernetes  API</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#working-with-k8s-objects" class="sidebar-link">Working with K8S Objects</a></li></ul></li><li><a href="/back_end/Kubernetes.html#cluster-architecture" class="sidebar-link">Cluster Architecture</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#nodes" class="sidebar-link">Nodes</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#control-plane-node-communication" class="sidebar-link">Control Plane-Node Communication</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#controllers" class="sidebar-link">Controllers</a></li><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#cloud-controller-manager" class="sidebar-link">Cloud Controller Manager</a></li></ul></li><li><a href="/back_end/Kubernetes.html#containers" class="sidebar-link">Containers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/Kubernetes.html#images" class="sidebar-link">Images</a></li></ul></li><li><a href="/back_end/Kubernetes.html#pods" class="sidebar-link">Pods</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="concepts"><a href="#concepts" class="header-anchor">#</a> Concepts</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <h3 id="why-you-need-kubernetes-and-what-it-can-do"><a href="#why-you-need-kubernetes-and-what-it-can-do" class="header-anchor">#</a> Why you need Kubernetes and what it can do</h3> <p>为了保存分布式容器没有宕机状态，我们需要在一个容器宕机时使用另一个容器顶替它。如果这个行为由同一个系统所管理，那么这样会更简单。这就是<code>Kubenetes</code> 所做的事情。</p> <p>K8s  provides you with a framework to run distributed systems resiliently.</p> <p><strong>K8S 为你提供：</strong></p> <ol><li><p>服务发现和负载均衡</p></li> <li><p>存储编排 (Storage orchestration)</p></li> <li><p>自动推出和回滚</p> <p>你可以将实际状态转变为你想要的状态以一个可控的比率。例如你可以创建一个新的容器，把已有的容器中的自己迁移到新的容器中，并抛弃旧的容器。</p></li> <li><p>Automatic bin packing</p> <p>当提供给K8S一个集群时，你可以设定每个container 所需要的资源（cpu 和 ram)，然后K8S可以把每个container放到你的nodes中，来充分利用资源。</p></li> <li><p>Self-healing</p></li> <li><p>Secret and configuration management</p> <p>You can deploy and update secrets and application configuration without rebuilding your container images, and without exposing secrets in your stack configuration.</p></li></ol> <p><strong>K8S不做的事：</strong></p> <ol><li>不限制应用类型。可以在容器上跑就可以在K8S上跑</li> <li>不部署源码也不构建项目</li> <li>不提供应用层的服务。但是这些服务可以通过portable mechanism（open service broker） 在K8S上跑</li> <li>不仅仅是一个编排系统，实际上消除了编排的需要。</li></ol> <h3 id="kubernetes-components"><a href="#kubernetes-components" class="header-anchor">#</a> Kubernetes Components</h3> <p><img src="https://d33wubrfki0l68.cloudfront.net/2475489eaf20163ec0f54ddc1d92aa8d4c87c96b/e7c81/images/docs/components-of-kubernetes.svg" alt=""></p> <h4 id="control-plane-components"><a href="#control-plane-components" class="header-anchor">#</a> Control Plane Components</h4> <p>control plane的组件是用来做集群的全局决策（如调度），检测，响应集群事件。</p> <p>虽然 Control plane components 可以在任意的族群机器上跑，但是为了简化我们通常只在一个机器上跑，这台机不会run user containers.<a href="https://kubernetes.io/docs/admin/high-availability/" target="_blank" rel="noopener noreferrer">Building High-Availability Clusters<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>Kube-apiserver</p></blockquote> <p>用来暴露 K8S API。可以水平扩展——部署多个实例。你可以跑多个 <strong>kube-apiserver</strong>的实例，并且在他们中取得平衡。</p> <blockquote><p>etcd</p></blockquote> <p>一个持久高可用的kv存储方式,来存储所有的集群数据</p> <p>如果使用etcd 作为集群的后备存储器，那么要确保这些数据有 <a href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster" target="_blank" rel="noopener noreferrer">备份<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 计划</p> <blockquote><p>kube-scheduler</p></blockquote> <p>改组件监视那些没有被分配node的新创建出来的pods，选择一个node给让pods 在上面跑。</p> <p>考虑的调度因素有：个体和集群资源需求，软硬件限制，亲和与非亲和规范，数据局部性，工作负载干扰和期限。</p> <blockquote><p>Kube-controller-manager</p></blockquote> <p>Run controller processes</p> <p>逻辑上，每一个controller 是一个独立的进程，但是为了简化它们被编译为一个二进制文件并且在一个进程里面跑。</p> <p>Some types of these controllers are:</p> <ul><li>Node controller: Responsible for noticing and responding when nodes go down.</li> <li>Job controller: Watches for Job objects that represent one-off tasks, then creates Pods to run those tasks to completion.</li> <li>Endpoints controller: Populates the Endpoints object (that is, joins Services &amp; Pods).</li> <li>Service Account &amp; Token controllers: Create default accounts and API access tokens for new namespaces.</li></ul> <blockquote><p>cloud-controller-manager</p></blockquote> <p>嵌入在特定云控制器的组件。cloud controller manager</p> <h4 id="node-components"><a href="#node-components" class="header-anchor">#</a> Node  Components</h4> <p>node components 运行在每个node上，持续地运行pods并且提供K8S的运行环境</p> <blockquote><p>kubelet</p></blockquote> <p>集群中每个node的代理商，它保证了容器在一个pod中跑并确保其健康</p> <blockquote><p>kube-proxy</p></blockquote> <p>Kube-proxy是一个网络代理，在集群中的每一个node上跑，维护 node 之间的网络规则。</p> <blockquote><p>Container  runtime</p></blockquote> <p>负责 run container</p> <p>容器想要做k8s上运行必须实现  <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-node/container-runtime-interface.md" target="_blank" rel="noopener noreferrer">Kubernetes CRI (Container Runtime Interface)<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <h4 id="addons-插件"><a href="#addons-插件" class="header-anchor">#</a> Addons(插件)</h4> <p>Addons 使用 k8s 资源来实现集群功能。由于它提供了集群级别的功能，addons的 namespace 属于 <code>kube-system</code></p> <h5 id="dns"><a href="#dns" class="header-anchor">#</a> DNS</h5> <p>尽管其他插件都并非严格意义上的必需组件，但几乎所有 Kubernetes 集群都应该 有<a href="https://kubernetes.io/zh/docs/concepts/services-networking/dns-pod-service/" target="_blank" rel="noopener noreferrer">集群 DNS<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Cluster DNS 为 k8s 提供DNS服务</p> <h3 id="the-kubernetes-api"><a href="#the-kubernetes-api" class="header-anchor">#</a> The Kubernetes  API</h3> <p>control plane 的核心。 Api 服务器暴露一个HTTP API  使得用户、集群中的不同部分和集群外部组件相互通信。</p> <p>API 可以让你查询和操作在k8s中api对象(pods, namespaces,configMaps,and Events)的状态。</p> <p>可使用<a href="https://kubernetes.io/docs/reference/kubectl/overview/" target="_blank" rel="noopener noreferrer">kubectl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>来执行大部分操作</p> <blockquote><p>使用openAPI 来实现API细节</p></blockquote> <blockquote><p>持久化</p></blockquote> <p>​	K8S 保存对象的序列化状态通过把它们写入 etcd</p> <blockquote><p>API groups and versioning</p></blockquote> <ul><li>支持多API 版本</li> <li>在API级别版本化</li> <li>To make it easier to evolve and to extend its API, Kubernetes implements <a href="https://kubernetes.io/docs/reference/using-api/#api-groups" target="_blank" rel="noopener noreferrer">API groups<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that can be <a href="https://kubernetes.io/docs/reference/using-api/#enabling-or-disabling" target="_blank" rel="noopener noreferrer">enabled or disabled<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</li></ul> <blockquote><p>API change</p></blockquote> <p>​		The Kubernetes project aims to <em>not</em> break compatibility with existing clients, and to maintain that compatibility for a length of time so that other projects have an opportunity to adapt.</p> <blockquote><p>API 扩展</p></blockquote> <ol><li><p><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank" rel="noopener noreferrer">Custom resources<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>implement <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/apiserver-aggregation/" target="_blank" rel="noopener noreferrer">aggregation layer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ol> <h3 id="working-with-k8s-objects"><a href="#working-with-k8s-objects" class="header-anchor">#</a> Working with K8S Objects</h3> <h4 id="understanding-k8s-objects"><a href="#understanding-k8s-objects" class="header-anchor">#</a> Understanding  k8s objects</h4> <p>Kubernetes 对象是 “目标性记录” —— 一旦创建对象，Kubernetes 系统将持续工作以确保对象存在。 通过创建对象，本质上是在告知 Kubernetes 系统，所需要的集群工作负载看起来是什么样子的， 这就是 Kubernetes 集群的 <strong>期望状态（Desired State）</strong>。</p> <p>每个object 都有 <code>spec</code> 和<code>status</code></p> <p><code>spec</code>:在创建时设置资源的理想状态</p> <p><code>status</code>描述当前object状态</p> <p><strong>描述一个K8S对象</strong></p> <p>通常地，需要吧object信息放在一个 .yaml 中给 <code>kubectl</code></p> <p>当做API请求时，<code>kubectl</code> 会把这些信息转化为 JSON</p> <blockquote><p>eg</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>deployment
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># tells deployment to run 2 pods matching the template</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>

   <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
     <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.14.2
     <span class="token key atrule">ports</span><span class="token punctuation">:</span>
     <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre></div><p>使用 <code>kubectl apply</code> create deployment</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl apply -f https://k8s.io/examples/application/deployment.yaml --record
</code></pre></div><p><strong>Required Fields</strong></p> <ul><li><p><code>appVersion</code> :你正在使用来创建对象的 K8S API版本</p></li> <li><p><code>kind</code>: 你想创建的对象地种类</p></li> <li><p><code>metadata</code>: 唯一识别对象。 (包括了 name,UID,namespace)</p></li> <li><p><code>spec</code>:你所希望的对象的状态</p> <p><a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/" target="_blank" rel="noopener noreferrer">Kubernetes API Reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> : spec format for all of the objects you can create</p> <p>Eg: <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#podspec-v1-core" target="_blank" rel="noopener noreferrer">PodSpec v1 core<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 、 <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#deploymentspec-v1-apps" target="_blank" rel="noopener noreferrer">DeploymentSpec v1 apps<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></li></ul> <h4 id="k8s-object-management"><a href="#k8s-object-management" class="header-anchor">#</a> k8s object management</h4> <p>使用 <code>kubectl</code> 管理对象，详见  <a href="https://kubectl.docs.kubernetes.io/" target="_blank" rel="noopener noreferrer">Kubectl book<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>关键命令</p></blockquote> <p>通过创建一个 Deployment对象，来跑一个nginx 容器的实例</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl create deployment nginx --image nginx
</code></pre></div><blockquote><p>imperative  object configuration</p></blockquote> <p>在 imperative  object configuration 中，kubectl 指定了操作（create, replace...）</p> <p>文件必须包括了对一个对象的完整定义（yaml /json）</p> <p>See the <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/" target="_blank" rel="noopener noreferrer">API reference<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> for more details on object definitions.</p> <h4 id="object-names-and-ids"><a href="#object-names-and-ids" class="header-anchor">#</a> object Names and IDs</h4> <p>在你的集群中，每个对象都有唯一的名字来标识同类资源的唯一性</p> <p>每个K8S对象也有一个UID，在整个集群中标识唯一性</p> <blockquote><p>Name</p></blockquote> <p>客户端提供的字符串，引用资源 url 中的对象，如<code>/api/v1/pods/some name</code></p> <blockquote><p>UIDs</p></blockquote> <p>旨在区分相似对象的发生历史</p> <h4 id="namespaces"><a href="#namespaces" class="header-anchor">#</a> Namespaces</h4> <p>K8S支持多个虚拟集群受同一个物理集群支持。 这些虚拟集群被称为<code>Namespaces</code></p> <p>如何创建和删除namespace <a href="https://kubernetes.io/docs/tasks/administer-cluster/namespaces/" target="_blank" rel="noopener noreferrer">Share a cluster with namespace<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>namespaces 是一个在多用户间划分集群资源的一个方法</p> <blockquote><p>使用 <code>--namespace</code></p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl run nginx --image<span class="token operator">=</span>nginx --namespace<span class="token operator">=</span><span class="token operator">&lt;</span>insert-namespace-name-here<span class="token operator">&gt;</span>
kubectl get pods --namespace<span class="token operator">=</span><span class="token operator">&lt;</span>insert-namespace-name-here<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p>查看那些资源有/无 namespace</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token comment"># In a namespace</span>
kubectl api-resources --namespaced<span class="token operator">=</span>true

<span class="token comment"># Not in a namespace</span>
kubectl api-resources --namespaced<span class="token operator">=</span>false
</code></pre></div><h4 id="labels-and-selectors"><a href="#labels-and-selectors" class="header-anchor">#</a> Labels and Selectors</h4> <p><strong>Labels</strong> :一个附加在对象上的键值对。旨在用来指定对象的标识属性</p> <blockquote><p>Motivation</p></blockquote> <p>标签使用户能够以松散耦合的方式将他们自己的组织结构映射到系统对象，而无需客户端存储这些映射。</p> <p>服务部署和批处理流水线通常是多维实体（例如，多个分区或部署、多个发行序列、多个层，每层多个微服务）。 管理通常需要交叉操作，这打破了严格的层次表示的封装，特别是由基础设施而不是用户确定的严格的层次结构。</p> <blockquote><p>Commonly used labels</p></blockquote> <ul><li><code>&quot;release&quot; : &quot;stable&quot;</code>, <code>&quot;release&quot; : &quot;canary&quot;</code></li> <li><code>&quot;environment&quot; : &quot;dev&quot;</code>, <code>&quot;environment&quot; : &quot;qa&quot;</code>, <code>&quot;environment&quot; : &quot;production&quot;</code></li> <li><code>&quot;tier&quot; : &quot;frontend&quot;</code>, <code>&quot;tier&quot; : &quot;backend&quot;</code>, <code>&quot;tier&quot; : &quot;cache&quot;</code></li> <li><code>&quot;partition&quot; : &quot;customerA&quot;</code>, <code>&quot;partition&quot; : &quot;customerB&quot;</code></li> <li><code>&quot;track&quot; : &quot;daily&quot;</code>, <code>&quot;track&quot; : &quot;weekly&quot;</code></li></ul> <p><strong>Label selector</strong>: 用户可以识别一组对象</p> <p>用法</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl get pods -l <span class="token assign-left variable">environment</span><span class="token operator">=</span>production,tier<span class="token operator">=</span>frontend
kubectl get pods -l <span class="token string">'environment in (production),tier in (frontend)'</span>
kubectl get pods -l <span class="token string">'environment in (production, qa)'</span>
kubectl get pods -l <span class="token string">'environment,environment notin (frontend)'</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;selector&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;component&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;redis&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> redis
</code></pre></div><div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">selector</span><span class="token punctuation">:</span>
  <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
    <span class="token key atrule">component</span><span class="token punctuation">:</span> redis
  <span class="token key atrule">matchExpressions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> tier<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> In<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>cache<span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">-</span> <span class="token punctuation">{</span><span class="token key atrule">key</span><span class="token punctuation">:</span> environment<span class="token punctuation">,</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> NotIn<span class="token punctuation">,</span> <span class="token key atrule">values</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>dev<span class="token punctuation">]</span><span class="token punctuation">}</span>
</code></pre></div><h4 id="recommended-labels"><a href="#recommended-labels" class="header-anchor">#</a> Recommended Labels</h4> <p>标签和注释都会有一个前缀：<code>app.kubernetes.io</code>.没有前缀的标签时用户私有的。</p> <p>共享的prefix确保了共享的label不会影响用户标签</p> <table><thead><tr><th>Key</th> <th>Description</th> <th>Example</th> <th>Type</th></tr></thead> <tbody><tr><td><code>app.kubernetes.io/name</code></td> <td>The name of the application</td> <td><code>mysql</code></td> <td>string</td></tr> <tr><td><code>app.kubernetes.io/instance</code></td> <td>A unique name identifying the instance of an application</td> <td><code>mysql-abcxzy</code></td> <td>string</td></tr> <tr><td><code>app.kubernetes.io/version</code></td> <td>The current version of the application (e.g., a semantic version, revision hash, etc.)</td> <td><code>5.7.21</code></td> <td>string</td></tr> <tr><td><code>app.kubernetes.io/component</code></td> <td>The component within the architecture</td> <td><code>database</code></td> <td>string</td></tr> <tr><td><code>app.kubernetes.io/part-of</code></td> <td>The name of a higher level application this one is part of</td> <td><code>wordpress</code></td> <td>string</td></tr> <tr><td><code>app.kubernetes.io/managed-by</code></td> <td>The tool being used to manage the operation of an application</td> <td><code>helm</code></td> <td>string</td></tr></tbody></table> <blockquote><p>eg</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>abcxzy
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> <span class="token string">&quot;5.7.21&quot;</span>
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> database
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> wordpress
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> helm
</code></pre></div><p>The <code>Deployment</code> is used to oversee the pods running the application itself.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> myservice
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> myservice<span class="token punctuation">-</span>abcxzy
<span class="token punctuation">...</span>
</code></pre></div><p>The <code>Service</code> is used to expose the application.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> myservice
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> myservice<span class="token punctuation">-</span>abcxzy
<span class="token punctuation">...</span>
</code></pre></div><p>MySQL is exposed as a <code>StatefulSet</code> with metadata for both it and the larger application it belongs to:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>abcxzy
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> <span class="token string">&quot;5.7.21&quot;</span>
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> database
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> wordpress
<span class="token punctuation">...</span>
</code></pre></div><p>The <code>Service</code> is used to expose MySQL as part of WordPress:</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app.kubernetes.io/name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">app.kubernetes.io/instance</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>abcxzy
    <span class="token key atrule">app.kubernetes.io/version</span><span class="token punctuation">:</span> <span class="token string">&quot;5.7.21&quot;</span>
    <span class="token key atrule">app.kubernetes.io/managed-by</span><span class="token punctuation">:</span> helm
    <span class="token key atrule">app.kubernetes.io/component</span><span class="token punctuation">:</span> database
    <span class="token key atrule">app.kubernetes.io/part-of</span><span class="token punctuation">:</span> wordpress
<span class="token punctuation">...</span>
</code></pre></div><h2 id="cluster-architecture"><a href="#cluster-architecture" class="header-anchor">#</a> Cluster Architecture</h2> <h3 id="nodes"><a href="#nodes" class="header-anchor">#</a> Nodes</h3> <p>Kubernetes 通过将容器放入在节点（Node）上运行的 Pod 中来执行你的工作负载</p> <p>每个node被control plane所管理，并包含了run pods 所需要的服务。</p> <p><strong>管理</strong>：</p> <p>将node加入加入API server</p> <ol><li>kubelet 自行注册到control plane</li> <li>user 手加入node对象</li></ol> <p>当你创建一个node对象,control plane 会检查它是否有效。如果node是健康的那么就有资格urn pods，否则它就会被忽略直到它变得健康。</p> <p><strong>Node name uniqueness</strong>:</p> <p><code>name</code> 可以识别node。两个node不可以同时有相同的名字（名字相同会被视为一个）。</p> <p>如何node需要更新或代替，那么需要先将现有的node object从API server 中移除然后再加入新的。</p> <p><strong>自我注册的nodes</strong></p> <ul><li><p><code>--kubeconfig</code> - Path to credentials to authenticate itself to the API server.</p></li> <li><p><code>--cloud-provider</code> - How to talk to a <a href="https://kubernetes.io/docs/reference/glossary/?all=true#term-cloud-provider" target="_blank" rel="noopener noreferrer">cloud provider<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to read metadata about itself.</p></li> <li><p><code>--register-node</code> - Automatically register with the API server.</p></li> <li><p><code>--register-with-taints</code> - Register the node with the given list of <a href="https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/" target="_blank" rel="noopener noreferrer">taints<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (comma separated <code>&lt;key&gt;=&lt;value&gt;:&lt;effect&gt;</code>).</p> <p>No-op if <code>register-node</code> is false.</p></li> <li><p><code>--node-ip</code> - IP address of the node.</p></li> <li><p><code>--node-labels</code> - <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/labels" target="_blank" rel="noopener noreferrer">Labels<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> to add when registering the node in the cluster (see label restrictions enforced by the <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#noderestriction" target="_blank" rel="noopener noreferrer">NodeRestriction admission plugin<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>).</p></li> <li><p><code>--node-status-update-frequency</code> - Specifies how often kubelet posts node status to master.</p></li></ul> <p><strong>手动管理node</strong>：</p> <p>You can create and modify Node objects using <a href="https://kubernetes.io/docs/user-guide/kubectl-overview/" target="_blank" rel="noopener noreferrer">kubectl<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <blockquote><p>Node status</p></blockquote> <p>使用<code>kubectl</code> 来查看node status 和其他细节</p> <div class="language-shell extra-class"><pre class="language-shell"><code>kubectl describe node <span class="token operator">&lt;</span>insert-node-name-here<span class="token operator">&gt;</span>
</code></pre></div><ul><li><p>address</p> <p>这些字段的用法取决于云供应商/裸机配置</p> <p><code>HostName</code>,<code>externalIP</code>,<code>InternalIP</code></p></li> <li><p>Conditions</p> <p>描述了所有<code>running</code> node的状态。</p> <table><thead><tr><th>Node Condition</th> <th>Description</th></tr></thead> <tbody><tr><td><code>Ready</code></td> <td><code>True</code> if the node is healthy and ready to accept pods, <code>False</code> if the node is not healthy and is not accepting pods, and <code>Unknown</code> if the node controller has not heard from the node in the last <code>node-monitor-grace-period</code> (default is 40 seconds)</td></tr> <tr><td><code>DiskPressure</code></td> <td><code>True</code> if pressure exists on the disk size--that is, if the disk capacity is low; otherwise <code>False</code></td></tr> <tr><td><code>MemoryPressure</code></td> <td><code>True</code> if pressure exists on the node memory--that is, if the node memory is low; otherwise <code>False</code></td></tr> <tr><td><code>PIDPressure</code></td> <td><code>True</code> if pressure exists on the processes—that is, if there are too many processes on the node; otherwise <code>False</code></td></tr> <tr><td><code>NetworkUnavailable</code></td> <td><code>True</code> if the network for the node is not correctly configured, otherwise <code>False</code></td></tr></tbody></table></li> <li><p>Capacity and allocatable</p> <p>描述了node可用的资源</p></li> <li><p>info</p> <p>node的基本信息</p></li></ul> <blockquote><p>Node contoller</p></blockquote> <p>node controller 用于管理node的各个方面，在node的生命中它扮演了多个角色。</p> <ul><li>分配一个CIDR区块给node当它注册的时候</li> <li>保持了node controller 内部的 node lists 和 cloud provider的 所提供的可用机器列表同步。</li> <li>监控node的健康状况</li></ul> <blockquote><p>心跳机制</p></blockquote> <p>心跳由node发出，决定了node的可用性</p> <p>有两种形式的heartbeats <code>nodeStatus</code>和 a Lease object</p> <blockquote><p>可靠性</p></blockquote> <p>大部分情况下，controller会限制每秒的驱逐比例<code>--node-eviction-rate</code> (0.1/s)</p> <h3 id="control-plane-node-communication"><a href="#control-plane-node-communication" class="header-anchor">#</a> Control Plane-Node Communication</h3> <blockquote><p>node to Control Plane</p></blockquote> <p>k8s 采用 hub-and-spoke  API 模式。所有从nodes来的API的调用都会在apiserver终止。APIserver被配置了监听远程连接在一个安全的https端口上（通常为443）</p> <p>一种或多种客户端<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/authorization/" target="_blank" rel="noopener noreferrer">鉴权机制<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>应该被启用， 特别是在允许使用<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#anonymous-requests" target="_blank" rel="noopener noreferrer">匿名请求<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 或<a href="https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#service-account-tokens" target="_blank" rel="noopener noreferrer">服务账号令牌<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>的时候。</p> <p>应该使用集群的公共根证书开通节点，这样它们就能够基于有效的客户端凭据安全地连接 apiserver。</p> <p>Pods 安全的连接apiserver通过利用一个service account</p> <blockquote><p>Control Plane to node</p></blockquote> <p>从plane（apiserver）到nodes 有两种主要路径</p> <ol><li><p>从APIserver 到 运行在集群上每一个nodes的kubelet 进程</p> <p>Apiserver 不会认证kubelet 的服务证书，可能会有中间人攻击，在不受信任/公共网络也是不安全的。</p></li> <li><p>通过apiserver 的代理功能,apiserver 到任何一个node，pod，service。</p> <p>apiserver 到 node, pod,service or service 默认是空白的http连接因此没有授权和加密。这种连接目前是不安全的。</p></li></ol> <blockquote><p>Konnectivity service</p></blockquote> <p>SSH tunnels 的替代品，提供了control plane 到集群的 TCP 层的代理。</p> <p>Konnectivity service 包含了两个部分，在集群中的 Konnectivity server 和在node 中的Konnectivity agents。</p> <p>Agents 建立连接到server 并且维持网络连接。当到service连接可用时，所有control plane到nodes 的流量都会走这个连接。</p> <h3 id="controllers"><a href="#controllers" class="header-anchor">#</a> Controllers</h3> <p>在k8s中，controller 是一个用来监视你的集群状态的控制环。每个控制器都试图使当前实际集群状态更加接近desired state.</p> <blockquote><p>通过 API 服务器来控制</p></blockquote> <p>Job 是一种 Kubernetes 资源，它运行一个或者多个 <a href="https://kubernetes.io/docs/concepts/workloads/pods/pod-overview/" target="_blank" rel="noopener noreferrer">Pod<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>， 来执行一个任务然后停止。</p> <p>Job 自己本身不run 任何pods 和 container，而是告诉api server  来create/remove  Pods。</p> <p>创建新 Job 后，所期望的状态就是完成这个 Job。Job 控制器会让 Job 的当前状态不断接近期望状态：创建为 Job 要完成工作所需要的 Pod，使 Job 的状态接近完成。</p> <p>控制器也会更新配置对象。例如：一旦 Job 的工作完成了，Job 控制器会更新 Job 对象的状态为 <code>Finished</code>。</p> <blockquote><p>Direct control</p></blockquote> <p>有些controller 需要对集群外部进行改变。</p> <p>如使用一个控制闭环来保证集群中有足够的nodes，那么controller需要一些集群外部的东西来启动我们需要的新nodes。</p> <p><strong>关键</strong>：controller 为得到desired state做出了一些改变，那么会把当前状态汇报给集群的api server.其他控制闭环可以观测的被汇报的数据，从而作出自己的行动。</p> <blockquote><p>Design</p></blockquote> <p>设计原则之一，每一个controller 管理集群特定的每一个方面。</p> <p>大部分情况下，一个特定的control loop  使用一个资源作为它的desired state，并且有一个不同的资源用来管理让你希望的状态发生。</p> <blockquote><p>运行 controller 的方法</p></blockquote> <p>k8s内置的一组控制器，运行在 <a href="https://kubernetes.io/docs/reference/generated/kube-controller-manager/" target="_blank" rel="noopener noreferrer">kube-controller-manager<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 。如 Deployment,job就是内置的控制器.</p> <p>可以自己写controller。然后run 你自己的controller as a set of Pods.</p> <h3 id="cloud-controller-manager"><a href="#cloud-controller-manager" class="header-anchor">#</a> Cloud Controller Manager</h3> <p>Cloud Controller Manager 使你连接集群到cloud provider‘s API，并分离出相互作用的组件与您的集群交互的组件。</p> <p>通过分离 Kubernetes 和底层云基础设置之间的互操作性逻辑， 云控制器管理器组件使云提供商能够以不同于 Kubernetes 主项目的速度进行发布新特征。</p> <p><strong>The controller inside the cloud controller:</strong></p> <blockquote><p>Node controller</p></blockquote> <p>node controller 负责当在你的cloud infra 中有新的servers被创建时，创建新的node objects。</p> <p>node controller执行4个function</p> <ol><li>为每个server初始化一个node object</li> <li>利用特定云平台的信息为 Node 对象添加注解和标签</li> <li>获取节点的网络地址和主机名</li> <li>检查节点的健康状况</li></ol> <blockquote><p>route controller</p></blockquote> <p>负责在cloud中合理的配置路由，使得在不同nodes上的containers可以互相通信。</p> <p>根据cloud provider，router controller 也可能会给pods飞来ip 地址块</p> <blockquote><p>Service controller</p></blockquote> <p>用来集成cloud infra components 比如负载均衡，ip 地址，网络过滤 和健康检测。</p> <p><strong>Authorization:</strong></p> <p>讲述了cloud controller mangers 为了完成操作需要的各种API objects.</p> <blockquote><p>node controller</p></blockquote> <p>需要read and modify node objects 完全权限</p> <p><code>v1/Node</code>:</p> <ul><li>Get</li> <li>List</li> <li>Create</li> <li>Update</li> <li>Patch</li> <li>Watch</li> <li>Delete</li></ul> <blockquote><p>Route controller</p></blockquote> <p>负责监听node的创建并合理配置路由。需要Get access</p> <p><code>v1/Node</code>:</p> <ul><li>Get</li></ul> <blockquote><p>Service controller</p></blockquote> <p>To access Services, it requires List, and Watch access. To update Services, it requires Patch and Update access.</p> <p>To set up Endpoints resources for the Services, it requires access to Create, List, Get, Watch, and Update.</p> <p><code>v1/Service</code>:</p> <ul><li>List</li> <li>Get</li> <li>Watch</li> <li>Patch</li> <li>Update</li></ul> <blockquote><p>eg</p></blockquote> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cloud<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>manager
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> events
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">'*'</span>
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> nodes/status
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> patch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> services
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> patch
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> serviceaccounts
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> persistentvolumes
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> update
  <span class="token punctuation">-</span> watch
<span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token string">&quot;&quot;</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> endpoints
  <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> create
  <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> list
  <span class="token punctuation">-</span> watch
  <span class="token punctuation">-</span> update
</code></pre></div><h2 id="containers"><a href="#containers" class="header-anchor">#</a> Containers</h2> <p>你跑的每一个container都是重复的，包括依赖环境在内的标准意味着无论你在哪跑你都会得到相同的行为。</p> <h3 id="images"><a href="#images" class="header-anchor">#</a> Images</h3> <p>Container image 代表了一个的application和它所有依赖的一个二进制压缩包</p> <p>通常地，你会创建你的application 的container image，并且把它推到一个仓库,然后在一个pos中引用它。</p> <blockquote><p>Image names</p></blockquote> <h1 id="workloads"><a href="#workloads" class="header-anchor">#</a> Workloads</h1> <h2 id="pods"><a href="#pods" class="header-anchor">#</a> Pods</h2></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.84cbfe9a.js" defer></script><script src="/assets/js/2.97ad032c.js" defer></script><script src="/assets/js/10.6f6050b0.js" defer></script>
  </body>
</html>

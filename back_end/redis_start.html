<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis | DanielGao&#39;s Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Hello World">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.84cbfe9a.js" as="script"><link rel="preload" href="/assets/js/2.97ad032c.js" as="script"><link rel="preload" href="/assets/js/18.f1919206.js" as="script"><link rel="prefetch" href="/assets/js/10.6f6050b0.js"><link rel="prefetch" href="/assets/js/11.314a169a.js"><link rel="prefetch" href="/assets/js/12.44c5ee57.js"><link rel="prefetch" href="/assets/js/13.f2574ab5.js"><link rel="prefetch" href="/assets/js/14.9878853c.js"><link rel="prefetch" href="/assets/js/15.6fb7ebac.js"><link rel="prefetch" href="/assets/js/16.0ad1fc40.js"><link rel="prefetch" href="/assets/js/17.24a22417.js"><link rel="prefetch" href="/assets/js/19.25662fd9.js"><link rel="prefetch" href="/assets/js/3.60832a0f.js"><link rel="prefetch" href="/assets/js/4.e7c996f5.js"><link rel="prefetch" href="/assets/js/5.6eff8140.js"><link rel="prefetch" href="/assets/js/6.17d5dd20.js"><link rel="prefetch" href="/assets/js/7.e59ee139.js"><link rel="prefetch" href="/assets/js/8.7162edc7.js"><link rel="prefetch" href="/assets/js/9.67af75ac.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">DanielGao's Blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Back End
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back_end/docker_command.html" class="nav-link">
  Docker 命令
</a></li><li class="dropdown-subitem"><a href="/back_end/docker_jottings.html" class="nav-link">
  Docker 随笔
</a></li><li class="dropdown-subitem"><a href="/back_end/Kubernetes.html" class="nav-link">
  K8S
</a></li><li class="dropdown-subitem"><a href="/back_end/redis_start.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis Start
</a></li></ul></li><li class="dropdown-item"><h4>
          Algorithm notes
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/algorithm/basic_template.html" class="nav-link">
  常用算法模板
</a></li><li class="dropdown-subitem"><a href="/algorithm/PAT.html" class="nav-link">
  PAT tips
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便写写" class="dropdown-title"><span class="title">随便写写</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便写写" class="mobile-dropdown-title"><span class="title">随便写写</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jottings/introduction.html" class="nav-link">
  前言
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Gaoyan1999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="学习笔记" class="dropdown-title"><span class="title">学习笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="学习笔记" class="mobile-dropdown-title"><span class="title">学习笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          Back End
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/back_end/docker_command.html" class="nav-link">
  Docker 命令
</a></li><li class="dropdown-subitem"><a href="/back_end/docker_jottings.html" class="nav-link">
  Docker 随笔
</a></li><li class="dropdown-subitem"><a href="/back_end/Kubernetes.html" class="nav-link">
  K8S
</a></li><li class="dropdown-subitem"><a href="/back_end/redis_start.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  Redis Start
</a></li></ul></li><li class="dropdown-item"><h4>
          Algorithm notes
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/algorithm/basic_template.html" class="nav-link">
  常用算法模板
</a></li><li class="dropdown-subitem"><a href="/algorithm/PAT.html" class="nav-link">
  PAT tips
</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="随便写写" class="dropdown-title"><span class="title">随便写写</span> <span class="arrow down"></span></button> <button type="button" aria-label="随便写写" class="mobile-dropdown-title"><span class="title">随便写写</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jottings/introduction.html" class="nav-link">
  前言
</a></li></ul></div></div><div class="nav-item"><a href="https://github.com/Gaoyan1999" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Redis</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/back_end/redis_start.html#概述" class="sidebar-link">概述</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#作用" class="sidebar-link">作用</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#单线程的redis" class="sidebar-link">单线程的Redis</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#五大基础类型" class="sidebar-link">五大基础类型</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#三种特殊类型" class="sidebar-link">三种特殊类型</a></li></ul></li><li><a href="/back_end/redis_start.html#事务" class="sidebar-link">事务</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#事务流程" class="sidebar-link">事务流程</a></li></ul></li><li><a href="/back_end/redis_start.html#锁" class="sidebar-link">锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#乐观锁" class="sidebar-link">乐观锁</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#悲观锁" class="sidebar-link">悲观锁</a></li></ul></li><li><a href="/back_end/redis_start.html#jedis" class="sidebar-link">Jedis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#环境配置" class="sidebar-link">环境配置</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#整合-springboot" class="sidebar-link">整合 SpringBoot</a></li></ul></li><li><a href="/back_end/redis_start.html#redis-conf-详解" class="sidebar-link">Redis.conf 详解</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/back_end/redis_start.html#redis-持久化" class="sidebar-link">Redis 持久化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#rdb-fork进程" class="sidebar-link">RDB：fork进程</a></li><li class="sidebar-sub-header"><a href="/back_end/redis_start.html#aof-append-only-file-读写文件" class="sidebar-link">AOF （append only file）：读写文件</a></li></ul></li><li><a href="/back_end/redis_start.html#redis-发布订阅" class="sidebar-link">Redis 发布订阅</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/back_end/redis_start.html#redis-主从复制" class="sidebar-link">Redis 主从复制</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/back_end/redis_start.html#哨兵模式" class="sidebar-link">哨兵模式</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/back_end/redis_start.html#redis-缓存和雪崩" class="sidebar-link">Redis 缓存和雪崩</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="redis"><a href="#redis" class="header-anchor">#</a> Redis</h1> <h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <blockquote><p><strong>Re</strong>mote <strong>Di</strong>cationary <strong>S</strong>erver:远程字典服务</p></blockquote> <p><a href="https://redis.io/" target="_blank" rel="noopener noreferrer">Redis官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <ol><li>内存存储、持久化，内存一断电就没了所以持久化很重要。（rdb、aof）</li> <li>效率高、可以用来高速缓存</li> <li>发布订阅系统</li> <li>地图信息分享</li> <li>计时器、计数器</li></ol> <h3 id="安装"><a href="#安装" class="header-anchor">#</a> 安装</h3> <ul><li><p>启动redis-server.exe</p></li> <li><p>打开redis-cli.exe</p> <p>简单的set get</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">ping</span>
PONG
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> key1 name1
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get key1
<span class="token string">&quot;name1&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span>
</code></pre></div></li> <li><p>Linux安装</p> <blockquote><ul><li>下载安装包  <code>redis-5.0.8.tar.gz</code></li></ul> <p>街道redis的安装包，到/opt目录下</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">mv</span> redis-5.0.5.tar.gz /opt
</code></pre></div><ul><li>解压</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">tar</span> -zxvf redis-5.0.5.tar.gz 
</code></pre></div><p><img src="https://gaoyan1999.oss-cn-beijing.aliyuncs.com/md/2021-05-30-111120.png" alt=""></p> <ul><li>安装gcc：</li></ul> <div class="language-shell extra-class"><pre class="language-shell"><code>yum <span class="token function">install</span> gcc-c++
<span class="token function">make</span> 
<span class="token function">make</span> <span class="token comment"># 再一次</span>
<span class="token function">make</span> <span class="token function">install</span>
</code></pre></div><ul><li>redis 默认路径 ： <code>usr/local/bin</code></li></ul> <p>把配置文件copy到自己的 <code>usr/local/bin/myconfig</code>目录</p> <ul><li>设置为后台启动</li></ul> <p>去自己的redis.config 把daemonize no 改为yes</p> <p>在bin下运行  <code>redis-server myconfig/redis.conf</code></p> <p>使用客户端连接： <code>redis-cli -p 6379</code></p></blockquote></li></ul> <h1 id="基础知识"><a href="#基础知识" class="header-anchor">#</a> 基础知识</h1> <p>​		<a href="http://www.redis.cn/commands.html" target="_blank" rel="noopener noreferrer">Redis 命令<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li><p>redis有16个数据库，默认使用第0个，可以使用select切换数据库。</p> <p><strong>select  3</strong>：选择三号数据库</p> <p><strong>DBSIZE</strong>:	查看大小</p></li> <li><p>查看某数据库所有的key</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keys *
</code></pre></div></li> <li><p>清空</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> flushdb <span class="token comment">#清空当前db</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> flushall <span class="token comment"># 清空所有</span>
</code></pre></div></li></ol> <h3 id="单线程的redis"><a href="#单线程的redis" class="header-anchor">#</a> 单线程的Redis</h3> <p>redis是很快的，官方表示Redis是<strong>基于内存</strong>操作的，CPU不是Redis的性能瓶颈，Redis的瓶颈是根据计算机的内存和网络带宽决定的，既然可以使用单线程来实现，就使用单线程。</p> <blockquote><p>为什么 Redis 这么快</p></blockquote> <p>Redis 是C语言写的，官方提供的数据为 100000 +  QPS，完全不必使用key-value的Memecache差！</p> <blockquote><p>为什么单线程还快</p></blockquote> <p>误区1：高性能服务器一定是多线程</p> <p>误区2：多线程一定比单线程效率高 （CPU会上下文切换回！）</p> <blockquote><p>redis 把数据都放在内存中</p></blockquote> <p>所以使用单线程操作效率高，对于内存系统来说没有上下文切换的效率就是最高的！多次读写都在一个CPU上</p> <p>redis可以做数据库、缓存、消息中间件MQ。</p> <h3 id="五大基础类型"><a href="#五大基础类型" class="header-anchor">#</a> 五大基础类型</h3> <blockquote><p>Redis-key</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>exists name1 <span class="token comment">#判断key是否存在</span>
move name1  <span class="token number">1</span> <span class="token comment">#移动到1号数据库</span>
<span class="token builtin class-name">set</span> key value
get key
expire name1 <span class="token number">10</span> <span class="token comment">#name键10s过期</span>
<span class="token builtin class-name">type</span> name1   <span class="token comment">#查看类型</span>
</code></pre></div><blockquote><p>String</p></blockquote> <div class="language-shell extra-class"><pre class="language-shell"><code>append key <span class="token string">&quot;hello&quot;</span>  <span class="token comment">#追加，若不存在相当于set</span>
strlen key <span class="token comment">#得到长度</span>

<span class="token comment">#####</span>

incr views <span class="token comment">#给一个数字 +1</span>
decr views <span class="token comment">#给一个数字-1</span>
incrby views <span class="token number">10</span> <span class="token comment">#10步长</span>

<span class="token comment">#####</span>

getrange name <span class="token number">0</span> <span class="token number">6</span>  <span class="token comment">#截取字符串</span>
getrange name <span class="token number">0</span> -1 <span class="token comment">#查看全部</span>
setrange name <span class="token number">0</span> XXX <span class="token comment">#在name的0位置插入</span>

<span class="token comment">#####</span>
setex key2 <span class="token number">30</span> hello <span class="token comment">#设置30s过期</span>
setnx key2 redis <span class="token comment">#不存在该key才设置，若存在则失败</span>

<span class="token comment">##### 批量操作</span>
mset key1 c1 key2 c2 <span class="token comment">#批量设置</span>
mget  key1 k2 k3 <span class="token comment">#批量获取</span>
msetnx k4 v4  k5 v5 <span class="token comment">#原子性操作，一起成功/失败</span>


<span class="token comment">##对象</span>
 <span class="token builtin class-name">set</span> user:1 <span class="token punctuation">{</span>name:zhangsan,age:12<span class="token punctuation">}</span> <span class="token comment">#设置对象保存为字符串</span>
 <span class="token builtin class-name">set</span> user:1:name  gao <span class="token comment">#user[1].name=gao</span>
 
 
 <span class="token comment">###组合</span>
 getset db redis <span class="token comment">#先拿到原来的再设置新的，若不存在返回NULL</span>
</code></pre></div><blockquote><p>List</p></blockquote> <p>列表：可以当做栈，队列。其本质是链表。list操作都是L开头的</p> <div class="language-bash extra-class"><pre class="language-bash"><code>lrange list <span class="token number">0</span> -1 <span class="token comment">#获得队列的值</span>


lpush list <span class="token number">6</span> <span class="token number">7</span> <span class="token number">8</span> <span class="token number">9</span> <span class="token comment">#(栈形式)后放的在上面，先放的在下面</span>
rpush list <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token number">4</span> <span class="token comment">#(队列形式) 先放的在上面，后方的在下面</span>


lpop list <span class="token comment">#左移除一个</span>
rpop list <span class="token comment">#右移除一个</span>

lrem list <span class="token number">2</span>  XXX <span class="token comment"># </span>


lindex list <span class="token number">4</span> <span class="token comment">#获得下标为3</span>
Llen  list <span class="token comment"># 获得长度</span>


lrem list <span class="token number">2</span> one <span class="token comment">#移除list中两个值为one的元素</span>
ltrim list <span class="token number">1</span> <span class="token number">2</span> <span class="token comment">#截指定长度，从list2[1]开始的两个元素</span>


rpoplpush list1 list2 <span class="token comment">#移除最后一个元素将他移动到新的列表中。</span>
lset list  <span class="token number">1</span>  otherValue <span class="token comment">#将list[1]的值改为otherValue,若不存在则报错</span>

 linsert list2 before hello1.5 hello1 <span class="token comment">#在hello1.5前插入hello1</span>

</code></pre></div><blockquote><p>Set（集合）</p></blockquote> <p>Set中的值不可重复，指令以S开头。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>sadd myset <span class="token number">1</span> <span class="token number">2</span> <span class="token number">3</span> <span class="token comment">#添加元素</span>
smemebers myset <span class="token comment">#指定查看所有值</span>
sismember myset <span class="token number">1</span> <span class="token comment">#判断集合中是否有1元素</span>
scard myset 	<span class="token comment">#获取值</span>
srem myset <span class="token number">1</span> 	<span class="token comment">#移除1元素</span>
srandmember myset  <span class="token number">1</span>  <span class="token comment">#获得一个随机元素 </span>
spop myset <span class="token comment">#随机弹出set元素</span>
smove  set1 set2  hello  <span class="token comment">#把set1的hello移动到set2中</span>
</code></pre></div><p>例：共同关注（交集）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">sdiff</span> set1 set2 <span class="token comment">#差集  set1-set2</span>
dinter set1 set2 <span class="token comment">#交集</span>
sunion set1 set2 <span class="token comment">#并集</span>
</code></pre></div><blockquote><p>Hash（哈希）</p></blockquote> <p>Map,key-Map集合。以h开头，本质和 String没有太大区别还是k-v对。</p> <p>应用：hash 变更的数据user name  age,尤其是用户信息之类的，经常变动的信息。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>hset <span class="token builtin class-name">hash</span> field1 gao <span class="token comment">#存</span>
hget <span class="token builtin class-name">hash</span> field1  <span class="token comment">#取</span>

hmset <span class="token builtin class-name">hash</span>  f1 v1 f2 v2 <span class="token comment">#set多个字段</span>
hmget <span class="token builtin class-name">hash</span> f1 f2 <span class="token comment">#get多个字段</span>

hgetall <span class="token builtin class-name">hash</span> <span class="token comment">#获得所有</span>
hdel <span class="token builtin class-name">hash</span> f1 <span class="token comment">#删除hash指定的key字段</span>

hlen <span class="token builtin class-name">hash</span> <span class="token comment">#获取hash长度</span>

hexists myhash f1<span class="token comment">#判断hash中指定的字段是否存在</span>

hkeys <span class="token builtin class-name">hash</span>  <span class="token comment">#获得所有</span>
hvals <span class="token builtin class-name">hash</span>


hincrby <span class="token builtin class-name">hash</span> f1 <span class="token number">1</span> <span class="token comment">#f1的值自增1</span>

hsetnx <span class="token builtin class-name">hash</span> f1 <span class="token number">122</span> <span class="token comment">#若存在则不能设置，不存在则可以</span>
</code></pre></div><blockquote><p>Zset （有序集合）</p></blockquote> <p>在set的基础上增加了一个计数位</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> hsetnx <span class="token builtin class-name">hash</span> f1 <span class="token number">122</span>
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">0</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> zadd zset <span class="token number">1</span> one <span class="token number">2</span> two <span class="token number">3</span> three
<span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">3</span>
<span class="token number">127.0</span>.0.1:6379<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> zrange zset <span class="token number">0</span> -1
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">&quot;one&quot;</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">&quot;two&quot;</span>
<span class="token number">3</span><span class="token punctuation">)</span> <span class="token string">&quot;three&quot;</span>


<span class="token comment">#排序</span>
ZRANGEBYSCORE zset -inf +inf
zrevrange  zset <span class="token number">0</span> -1 <span class="token comment">#倒叙</span>
withscores<span class="token comment">#指定范围排序</span>
<span class="token comment">#withscores表示带序号</span>


zrem zset one  <span class="token comment">#移除有序集合中的指定元素</span>
zcard zset <span class="token comment">#获得有序集合中个数</span>

zcount zset  <span class="token number">0</span> <span class="token number">10</span><span class="token comment">#获取区间的成员数量</span>
</code></pre></div><p>案例：工资表。给消息设置权重</p> <h3 id="三种特殊类型"><a href="#三种特殊类型" class="header-anchor">#</a> 三种特殊类型</h3> <h4 id="geospatial-地理位置"><a href="#geospatial-地理位置" class="header-anchor">#</a> geospatial 地理位置</h4> <p>用于附近的人，定位...</p> <p>这个功能可以推算两地之间的距离和附近的人。</p> <blockquote><p>6 个命令</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>geoadd china:shanghai <span class="token number">121.45</span> <span class="token number">31.23</span> jingan  <span class="token comment">#添加一个地理位置</span>
geodist china:shanghai huangpu yangpu  <span class="token comment">#返回两地距离</span>
geopos china:shanghai yangpu
<span class="token comment">#获取经纬度</span>

georadius china:shanghai <span class="token number">121.51</span> <span class="token number">31.26</span> <span class="token number">10</span> km  <span class="token comment">#在上海这个集合中找里[121.51,31.26] 10km 的地址</span>
<span class="token comment">#WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</span>
<span class="token comment">#WITHCOORD: 将位置元素的经度和维度也一并返回。</span>


georadiusbymember china:shanghai huangpu <span class="token number">1000</span> km
<span class="token comment">#找出位置与指定元素周围的其他元素</span>

geohash china:shanghai yangpu 
<span class="token comment">#返回hash值，把二维经纬度转化为以为字符串</span>
</code></pre></div><p>原理：底层的实现就是Zset，我可意义使用Zset操作geo，所有可以使用zrem 移除某地点</p> <h4 id="hyperloglogs"><a href="#hyperloglogs" class="header-anchor">#</a> Hyperloglogs</h4> <blockquote><p>基数：在一个数据集内，不重复的元素</p></blockquote> <p>Redis Hyperloglog :基数统计的算法。</p> <p>2^64 不同元素的计数，只要12kb的内存，如果从内存角度来比较的话Hyperloglog是首选。</p> <ul><li><p>案例：网页浏览量，一人访问多次还是算一个人</p> <p>传统方法：set保存用户id，然后就可以统计set中的元素熟料作为标准判断。</p> <p>这个方法如果保存大量用户id，就会比较麻烦。我们的目的只是为了计数，而不是保存用户id。</p></li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>PFadd hyperlog a b c d e f g h i j
<span class="token comment">#添加</span>

pfcount mykey <span class="token comment">#元素个数</span>

pfmerge hl3 hl1 hl2
<span class="token comment">#合并两个数据集</span>
</code></pre></div><h4 id="bitmaps"><a href="#bitmaps" class="header-anchor">#</a> Bitmaps</h4> <blockquote><p>位存储</p></blockquote> <p>用二进制位来进行记录，只有0/1两个状态。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>setbit sign <span class="token number">1</span>  <span class="token number">1</span>
setbit sign <span class="token number">2</span>  <span class="token number">0</span>
setbit sign <span class="token number">3</span>  <span class="token number">1</span>
getbit sign <span class="token number">1</span>
bitcount sign <span class="token comment">#统计记录</span>
</code></pre></div><h2 id="事务"><a href="#事务" class="header-anchor">#</a> 事务</h2> <blockquote><p>Redis 事务：一组命令的集合</p></blockquote> <p>一个事务中的所有命令都会被序列化，按照顺序执行。</p> <p>保证 一次性、顺序性、排他性。</p> <p>Redis 单条命令保证原子性，但是事务不保证<strong>原子性</strong>，且<strong>没有隔离级别</strong>的概念。所有命令在事务中，并没有直接被执行，只有发起执行命令的时候才会执行 Eexc。</p> <h3 id="事务流程"><a href="#事务流程" class="header-anchor">#</a> 事务流程</h3> <blockquote><p>正常使用事务</p></blockquote> <ul><li><p>开始事务</p> <p><code>multi</code></p></li> <li><p>命令入队</p> <p>输入各种语句.....</p></li> <li><p>执行事务</p> <p>exec</p></li></ul> <blockquote><p>放弃事务</p></blockquote> <p><code>discard</code>:开启事务后，写的命令都不会生效了</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> k1 v1
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get k1
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> k6 v6
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> discard
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> 

</code></pre></div><blockquote><p>命令异常时，事务中所有的命令都不会被执行，会被discard</p></blockquote> <blockquote><p>运行时异常，如果事务在存在异常，其他命令是会被执行的，该命令不会被执行。</p></blockquote> <h2 id="锁"><a href="#锁" class="header-anchor">#</a> 锁</h2> <h3 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁</h3> <p>很乐观，认为什么时候都不会出现问题，所以不会上锁。更新数据的时候去判断，在这个期间内是否有人<strong>改动</strong> 过该数据，(version)</p> <ul><li>获得version</li> <li>更新时比较 version</li></ul> <h3 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁</h3> <p>很悲观，觉得什么时候都会出现问题。无论什么都加锁，如synchronized</p> <blockquote><p>Redis 监控测试</p></blockquote> <p>事务正常结束，执行成功</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money
<span class="token comment">#监视对象</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> decrby money <span class="token number">20</span> 
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incrby out <span class="token number">20</span>
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">80</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">20</span>
</code></pre></div><blockquote><p>修改失败</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> decrby money <span class="token number">10</span>
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incrby out <span class="token number">10</span>
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token punctuation">(</span>nil<span class="token punctuation">)</span>
</code></pre></div><p>watch：相当于乐观锁，会拿到money的值，一旦money的值被修改，那么事务不会成功。</p> <p>另一个线程把money进行了修改。由于主线程用watch监视了money，主线程中的事务就会执行失败。</p> <blockquote><p>执行失败要解锁，重新watch</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> unwatch
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get money
<span class="token string">&quot;1000&quot;</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token function">watch</span> money
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> multi
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> decrby money <span class="token number">100</span>
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> incrby out <span class="token number">100</span>
QUEUED
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">exec</span>
<span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">900</span>
<span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>integer<span class="token punctuation">)</span> <span class="token number">120</span>

</code></pre></div><h2 id="jedis"><a href="#jedis" class="header-anchor">#</a> Jedis</h2> <blockquote><p>jedis ：redis 官方推荐的java链接开发工具、java操作redis的中间件。</p></blockquote> <h3 id="环境配置"><a href="#环境配置" class="header-anchor">#</a> 环境配置</h3> <ol><li>导入依赖</li></ol> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>redis.clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jedis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.62<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ol start="2"><li><p>测试</p> <ul><li><p>配置安全组，关闭防火墙</p></li> <li><p>连接数据库</p></li> <li><p>操作命令</p></li> <li><p>断开连接</p></li></ul></li></ol> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Jedis</span> jedis <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jedis</span><span class="token punctuation">(</span><span class="token string">&quot;182.92.112.81&quot;</span><span class="token punctuation">,</span><span class="token number">6379</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Long</span> java <span class="token operator">=</span> jedis<span class="token punctuation">.</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token string">&quot;java&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>java<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="整合-springboot"><a href="#整合-springboot" class="header-anchor">#</a> 整合 SpringBoot</h3> <p>在SpringBoot 2.X后，原来使用的jedis被替换为了lettuce。</p> <p>jedis：采用的直连，过个线程操作的话是不安全的，如果想要避免要是用jedis pool 连接池。更像 BIO 模式</p> <p>lettuce：采用netty，实例可以在多个线程中进行共享，不存在线程不安全的情况，可以减少线程数据了，更像 NIO模式</p> <div class="language-java extra-class"><pre class="language-java"><code>	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
        <span class="token comment">//默认的RedisTemple 没有过多的设置，redis对象是需要序列化的。</span>
        <span class="token comment">//两个泛型都是object，需要强转</span>
		<span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> template<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token keyword">public</span> <span class="token class-name">StringRedisTemplate</span> <span class="token function">stringRedisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
		<span class="token class-name">StringRedisTemplate</span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> template<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>整合测试</p></blockquote> <ol><li><p>导入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置链接</p></li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># springboot 所有的配置类，都有一个自动配置类，会绑定一个properties文件</span>
<span class="token attr-name">spring.redis.port</span><span class="token punctuation">=</span><span class="token attr-value">6379</span>
<span class="token attr-name">spring.redis.host</span><span class="token punctuation">=</span><span class="token attr-value">82.92.112.81</span>
</code></pre></div><ol start="3"><li><p>测试</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootTest</span>
<span class="token keyword">class</span> <span class="token class-name">RedisApplicationTests</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">contextLoads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//redisTemplate</span>
      <span class="token comment">//opsForValue 操作字符串，类似String</span>
      <span class="token comment">//opsForList  操作List ，类似List</span>
      <span class="token comment">//ops……操作各种数据</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;spring-redis&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;lettuce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里使用了默认的redistemplate，其中使用的是<code>JdkSerializationRedisSerializer</code>对数据进行序列化操作而造成了乱码，所有需要自己重写redistemplate</p></li></ol> <ul><li>解决方法</li></ul> <p>方法一：传递json字符串</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JsonProcessingException</span> <span class="token punctuation">{</span>
        <span class="token class-name">ValueOperations</span> valueOperations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">User</span> user<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">&quot;gao&quot;</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//序列化</span>
        <span class="token class-name">String</span> jsonUser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

        valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span>jsonUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>方法二：若想传递对象必须要对对象进行序列化</p> <p>默认为jdk方式</p> <div class="language-java extra-class"><pre class="language-java"><code> valueOperations<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;user2&quot;</span><span class="token punctuation">,</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>valueOperations<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;user2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果我们不想使用jdk的序列化方式，我们就需要重写redistemplate</p> <p>写自己的<strong>redisconfiguration</strong>，在其中配置自己的序列化方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> redisConnectionFactory<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{</span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>redisConnectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置自己的序列化方式</span>
        <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> jacksonSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Jackson2JsonRedisSerializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>jacksonSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ObjectMapper</span> om <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">setVisibility</span><span class="token punctuation">(</span><span class="token class-name">PropertyAccessor</span><span class="token punctuation">.</span>ALL<span class="token punctuation">,</span> <span class="token class-name">JsonAutoDetect<span class="token punctuation">.</span>Visibility</span><span class="token punctuation">.</span>ANY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        om<span class="token punctuation">.</span><span class="token function">enableDefaultTyping</span><span class="token punctuation">(</span><span class="token class-name">ObjectMapper<span class="token punctuation">.</span>DefaultTyping</span><span class="token punctuation">.</span>NON_FINAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        jacksonSerializer<span class="token punctuation">.</span><span class="token function">setObjectMapper</span><span class="token punctuation">(</span>om<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//所有key采用 string方式序列化，value采用jackson</span>
        <span class="token class-name">StringRedisSerializer</span> stringRedisSerializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setHashKeySerializer</span><span class="token punctuation">(</span>stringRedisSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span>jacksonSerializer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        template<span class="token punctuation">.</span><span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre></div><p>测试类中导入自己写的配置</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;redisTemplate&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>
</code></pre></div><h1 id="redis-进阶"><a href="#redis-进阶" class="header-anchor">#</a> Redis 进阶</h1> <h2 id="redis-conf-详解"><a href="#redis-conf-详解" class="header-anchor">#</a> Redis.conf 详解</h2> <p>对大小写不明感</p> <p><img src="https://gaoyan1999.oss-cn-beijing.aliyuncs.com/md/2021-05-30-111020.png" alt=""></p> <p>可以导入外部配置</p> <blockquote><p>网络</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0  <span class="token comment">#绑定ip</span>
protect-mode  no <span class="token comment">#保护模式</span>
</code></pre></div><blockquote><p>通用</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>daemonize <span class="token function">yes</span> <span class="token comment"># 以守护进程的方式运行，后台运行</span>

pidfile /var/run/redis_6379.pid <span class="token comment"># 如果以后台运行就要指定pid文件</span>


<span class="token comment"># 日志</span>

<span class="token comment"># Specify the server verbosity level.</span>
<span class="token comment"># This can be one of:</span>
<span class="token comment"># debug (a lot of information, useful for development/testing)</span>
<span class="token comment"># verbose (many rarely useful info, but not a mess like the debug level)</span>
<span class="token comment"># notice (moderately verbose, what you want in production probably)</span>
<span class="token comment"># warning (only very important / critical messages are logged)</span>
loglevel notice

<span class="token comment">#生成日志的文件名</span>

<span class="token comment"># Specify the log file name. Also the empty string can be used to force</span>
<span class="token comment"># Redis to log on the standard output. Note that if you use standard</span>
<span class="token comment"># output for logging but daemonize, logs will be sent to /dev/null</span>
logfile <span class="token string">&quot;&quot;</span>


</code></pre></div><blockquote><p>快照</p></blockquote> <p>持久化，在规定时间内执行了多少次操作，则会持久化到文件。</p> <p><img src="https://gaoyan1999.oss-cn-beijing.aliyuncs.com/md/2021-05-30-110857.png" alt=""></p> <p>900s之内，如果至少一个key修改了就会持久化。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#持久化出错是否继续执行</span>
stop-writes-on-bgsave-error <span class="token function">yes</span>
<span class="token comment">#是否压缩drb文件</span>
rdbcompression <span class="token function">yes</span>

<span class="token function">dir</span> ./ <span class="token comment">#rdb文件保存目录</span>
</code></pre></div><blockquote><p>append only 模式    aof配置</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>appendonly no <span class="token comment"># 默认不开启aof，因为大部分所有的情况家rdb完全够用</span>
appendfilename <span class="token string">&quot;appendonly.aof&quot;</span> <span class="token comment">#默认aof文件</span>



<span class="token comment"># appendfsync always 每次修改都会同步，消耗性能</span>
appendfsync everysec  <span class="token comment">#每秒同步，可能会都是数据</span>
<span class="token comment"># appendfsync no  #不同步，os自己同步，速度最快</span>

</code></pre></div><h2 id="redis-持久化"><a href="#redis-持久化" class="header-anchor">#</a> Redis 持久化</h2> <blockquote><p>RDB 与 AOF</p></blockquote> <p>Redis 是内存数据库，所以要交内存中的数据保存到磁盘。故redis提供了持久化功能。</p> <h3 id="rdb-fork进程"><a href="#rdb-fork进程" class="header-anchor">#</a> RDB：fork进程</h3> <p>在指定的时间间隔内将内存中的数据集快照写入磁盘（snapshot），恢复是将快照直接读到内存中。</p> <p>redis会单独创建一个子进程持久化，它把数据写到临时文件中，持久化结束了，用这个临时文件替换之前的文件。</p> <p>我们<strong>默认使用rdb</strong>，一般情况下不需要修改这个配置。</p> <p>rdb保存的文件是dump.rdb</p> <blockquote><p>触发机制</p></blockquote> <ol><li>save 的规则满足的情况下，会自动触发rdb规则</li> <li>flushall也会触发</li> <li>退出redis</li></ol> <blockquote><p>恢复rdb文件</p></blockquote> <p>​	只要把dump.rdb 放在redis启动目录下就可以，redis启动会自动检查</p> <blockquote><p>优劣</p></blockquote> <p>优点：</p> <ul><li><p>适合大规模的数据恢复</p></li> <li><p>若对数据的完整性不高，可以使用</p></li></ul> <p>缺点：</p> <ul><li><p>需要一定时间间隔进行操作，如果redis意外宕机了，最后一次修改数据就没有了</p></li> <li><p>fork 子进程需要单独的空间</p></li></ul> <h3 id="aof-append-only-file-读写文件"><a href="#aof-append-only-file-读写文件" class="header-anchor">#</a> AOF （append only file）：读写文件</h3> <p>以日志的形式来记录每个写操作，把redis所有执行过的指令都记录下来。<strong>只追加，不改写</strong>。记录到 appendonly.aof中</p> <p>若要开启，去配置文件修改：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>appendonly no <span class="token comment">#默认不开始，需要改为yes</span>
</code></pre></div><p>若appendonly.aof被破坏，可以使用redis-check-aof 修复</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis-check-aof --fix appendonly.aof
</code></pre></div><p>优点：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># appendfsync always 每次修改都会同步，消耗性能</span>
appendfsync everysec  <span class="token comment">#每秒同步，可能会都是数据</span>
<span class="token comment"># appendfsync no  #不同步，os自己同步，速度最快</span>
</code></pre></div><ul><li><p>每一次修改都追加，文件完整性会更加好</p></li> <li><p>每一秒同步一次可能会都是一秒的数据</p></li> <li><p>从不同步，效率最高</p></li></ul> <p>缺点：</p> <ul><li>相对于数据文件来说，aof远远大于edb，修复速度慢</li> <li>aof 运行效率也比rdb慢</li></ul> <h2 id="redis-发布订阅"><a href="#redis-发布订阅" class="header-anchor">#</a> Redis 发布订阅</h2> <p>redis 发布订阅是一种<strong>消息通信模式</strong>。发送者发消息，订阅者接收。</p> <blockquote><p>命令</p></blockquote> <div class="language-bash extra-class"><pre class="language-bash"><code>psubsribe paettern <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">#订阅</span>

pubsub subcommand <span class="token punctuation">[</span>argument <span class="token punctuation">[</span>argument<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment"># 查看订阅与发布系统状态</span>

publish channnel message <span class="token comment">#发送信息</span>

punsubsribe <span class="token punctuation">[</span>pattern <span class="token punctuation">[</span>pattern <span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">#退订所有给定模式的频道</span>

subsribe channel <span class="token punctuation">[</span>channel <span class="token punctuation">..</span><span class="token punctuation">]</span> <span class="token comment">#订阅给定的一个或多个频道信息</span>

unsubsribe <span class="token punctuation">[</span>channel  <span class="token punctuation">[</span>channel <span class="token punctuation">..</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token comment">#退订给定的频道</span>
</code></pre></div><p>只要订阅了，一旦发布立马被推送。</p> <h2 id="redis-主从复制"><a href="#redis-主从复制" class="header-anchor">#</a> Redis 主从复制</h2> <p>一台redis服务器(主节点)的数据，复制到其他的redis服务器（从节点）中。 数据只能从主节点复制到从节点是单向的。</p> <blockquote><p>主要作用</p></blockquote> <ol><li><p>数据冗余：实现了数据的热备份，是持久化之外的一种数据冗余方式</p></li> <li><p>故障恢复：主节点出问题时，从节点服务。</p></li> <li><p>负载均衡：在主从复制的基础上，配合读写分离，主节点写，从节点读。分担服务器的负载。在写少读多的场景下，通过多个节点分担读负载，从而提高并发量</p></li> <li><p>高可用(集群)：主从复制是哨兵模式和集群能够实施的基础</p></li></ol> <p>一般来说，工程项目中由于只有一台服务redis会宕机，单台redis内存最大使用<strong>内存不超过20gb</strong>，所有必须配置集群。一般来说都是一主二从。</p> <blockquote><p>环境配置</p></blockquote> <p>配置从库</p> <div class="language-bash extra-class"><pre class="language-bash"><code>info replication <span class="token comment">#查看redis当前库的信息</span>

</code></pre></div><p>复制三个配置文件，配置一主二从的配置</p> <p>修改每个配置文件的端口、pid、log文件、rdb文件名字</p> <blockquote><p>一主二从</p></blockquote> <p>将6379作为主机，6380,6381作为从机</p> <div class="language-bash extra-class"><pre class="language-bash"><code>slaveof <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token comment">#配置从机</span>
</code></pre></div><p>真实的主从配置要在配置文件中配置，用命令是暂时的</p> <div class="language-bash extra-class"><pre class="language-bash"><code> replicaof <span class="token operator">&lt;</span>masterip<span class="token operator">&gt;</span> <span class="token operator">&lt;</span>masterport<span class="token operator">&gt;</span>
</code></pre></div><blockquote><p>tips</p></blockquote> <p>主机只能写，从机只能读。</p> <p>主机的信息会被从机保存。</p> <p>如果主机宕机了，想要让从机接替主机变成新主机需要设置哨兵模式</p> <blockquote><p>复制原理</p></blockquote> <p>从机只要连接到主机就会发送同步命令，主机将说句传送整个数据文件到slave，并完成同步。</p> <p>如果主机断开了，从机使用 slaveof no one ，让自己变成主机。如果之前的主机回来了，那就只能从新连接了。</p> <h2 id="哨兵模式"><a href="#哨兵模式" class="header-anchor">#</a> 哨兵模式</h2> <blockquote><p>自选谁当主机的模式</p></blockquote> <p>后台监控主服务器是否故障，如果故障了根据投票数自动将从库转换为主库。</p> <p>哨兵是独立的进程，独立运行。哨兵通过发送命令，等待redis服务器响应，从而监控运行的多个redis实例。</p> <p>为了防止哨兵死了，也要配置多个哨兵互相监控。</p> <blockquote><p>一主二从的哨兵配置</p></blockquote> <p>在配置文件下排位置 <code>sentinel.conf</code></p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment">#sentinel monitor  被监控名  127.0.0.1 6379 投票</span>
sentinel monitor  myredis  <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">1</span>
</code></pre></div><p>1代表主机挂了，slave投票让谁来替换为主机</p> <p>启动哨兵</p> <div class="language-bash extra-class"><pre class="language-bash"><code>redis-sentinel myconfig/sentinel.conf
</code></pre></div><p>当主机shutdown时会进行投票故障转移，从机中有一个会变成主机</p> <p><img src="https://gaoyan1999.oss-cn-beijing.aliyuncs.com/md/2021-05-30-110950.png" alt=""></p> <blockquote><p>优点</p></blockquote> <ol><li>基于主从配置</li> <li>主从切换，故障转移</li> <li>哨兵模式是主从模式的升级，手动到自动更加健壮</li></ol> <blockquote><p>缺点</p></blockquote> <ol><li>redis不可以在线扩容，集群容量一旦到达上限，在线扩容十分麻烦</li> <li>全部的配置比较复杂</li></ol> <h2 id="redis-缓存和雪崩"><a href="#redis-缓存和雪崩" class="header-anchor">#</a> Redis 缓存和雪崩</h2> <h5 id="缓存穿透-查不到"><a href="#缓存穿透-查不到" class="header-anchor">#</a> 缓存穿透（查不到）</h5> <p>当用户想要查询一个数据，redis内存数据库里没有，于是想持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存未命中，于是都去请求持久层数据库。这会给持久层数据库造成很大的压力，这是就相当于出现了缓存穿透。</p> <blockquote><p>解决法案：</p></blockquote> <ul><li>在redis中增加过滤器</li></ul> <p>布隆过滤器：一种数据结构，对所有可能的参数以hash形式存储，在控制层现在进行校验，不符合直接丢弃，从而避免对底层存储系统的查询压力</p> <ul><li>在redis中增加空缓存</li></ul> <p>当缓存层未命中，存储层也没有时。存储层会返回一个空对象给缓存层并且设置一个过期时间，然后用户再去请求这个数据就回去缓存中拿，从而达到了保护后端数据的目的。</p> <blockquote><p>问题：</p></blockquote> <ol><li>空值也会被缓存，意味着缓存需要更多的空间来存储更多的没有值的键。</li> <li>即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致。</li></ol> <h5 id="缓存击穿-量太大-缓存过期"><a href="#缓存击穿-量太大-缓存过期" class="header-anchor">#</a> 缓存击穿（量太大，缓存过期）</h5> <p>与缓存穿透不同时，缓存击穿是指某一个key的访问量极大，一直在被高并发地访问。当这个key在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库。</p> <p>一般这类数据是热点数据，在该key过期的瞬间，高并发会同时访问数据库查询最新数据，并且写会缓存，从而导致数据库压力过大。</p> <blockquote><p>解决方案</p></blockquote> <ul><li>设置热点数据永不过期</li> <li>加互斥锁</li></ul> <p>分布式锁：使用分布式锁，保证对于每个key同时只有一个进程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发地压力转移到了分布式锁，对分布式锁的考验也大。</p> <h5 id="缓存雪崩"><a href="#缓存雪崩" class="header-anchor">#</a> 缓存雪崩</h5> <p>在某一个时间段，缓存集中过期，redis宕机。</p> <p>比如双十一期间访问量过大，服务器提前把一些商品信息存到缓存中，都设置了1h的过期时间，那么一小时后key集体过期，如果访问量还是过大，所有的请求都会直接访问存储层，容易把服务器压垮。</p> <blockquote><p>解决方案</p></blockquote> <ul><li>服务降级</li></ul> <p>停掉一些服务，保证主要的服务可用</p> <ul><li>redis高可用</li></ul> <p>多设置几台redis，搭建集群</p> <ul><li>数据预热</li></ul> <p>在正式部署之前，先把可能的数据先预先访问一边，这样部分可能大量访问的数据就会加载到缓存中。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.84cbfe9a.js" defer></script><script src="/assets/js/2.97ad032c.js" defer></script><script src="/assets/js/18.f1919206.js" defer></script>
  </body>
</html>
